<!doctype html>
<html>
<head>
  <title>Auto-Sheriff</title>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <script src="components/platform/platform.js"></script>
  <script src="scripts/repositories.js"></script>
  <script src="scripts/third_party/js_humanized_time_span/humanized_time_span.js"></script>
  <style>
  html,body {
    height: 100%;
    margin: 0;
    background-color: #E5E5E5;
    font-family: 'RobotoDraft', sans-serif;
  }
  </style>
  <link rel="import" href="components/font-roboto/roboto.html">
  <link rel="import" href="components/polymer/polymer.html">
  <link rel="import" href="components/core-ajax/core-ajax.html">
</head>

<body unresolved touch-action="auto">

<!-- FIXME: This should probably just be done via script. -->
<polymer-element name="nb-changelogs" attributes="passing failing" noscript>
  <template>
    <template if="{{passing}}">
      <template if="{{passing.chromium != failing.chromium}}">
        <a href='http://build.chromium.org/f/chromium/perf/dashboard/ui/changelog.html?url=/trunk&range={{ passing.chromium }}:{{failing.chromium}}'>Cr</a>
      </template>
      <template if="{{passing.blink != failing.blink}}">
        <a href='http://build.chromium.org/f/chromium/perf/dashboard/ui/changelog_blink.html?url=/trunk&range={{ passing.blink }}:{{failing.blink}}'>Bl</a>
      </template>
      <template if="{{passing.v8 != failing.v8}}">
        <a href='http://build.chromium.org/f/chromium/perf/dashboard/ui/changelog_v8.html?url=/trunk&range={{ passing.v8 }}:{{failing.v8}}'>v8</a>
      </template>
      <template if="{{passing.nacl != failing.nacl}}">
        nacl ({{ passing.nacl }}:{{ failing.nacl }})
      </template>
    </template>
    <template if="{{ !passing }}">
     Before:
     <a>Cr {{failing.chromium}} </a>
     <a>Bl {{failing.blink}} </a>
     <a>v8 {{failing.v8}} </a>
     <a>nacl {{failing.nacl}} </a>
    </template>
  </template>
</polymer-element>

<polymer-element name="nb-alert-list" attributes='failures'>
  <template>
    <style>
      :host {
        display: block;
      }
      .fail_link { background-color: #FCC;}
      .pass_link { background-color: #CFC;}
    </style>
    <table>
    <tr><th>master</th><th>builder</th><th>times</th><th>failure</th><th>edges</th><th>blame</th><th>when</th><th>closes</th></tr>
    <template repeat="{{ failure in failures }}">
      <template bind="{{ (failure.master_url + '/builders/' + failure.builder_name) as builder_url}}">
      <tr>
        <td>{{failure.master_url | master_name }}</td>
        <td><a href='{{builder_url}}'>{{failure.builder_name}}</a></td>
        <td>{{failure.failing_build_count}}</td>
        <td>
          <a href='{{builder_url}}/builds/{{failure.failing_build}}/steps/{{failure.step_name}}/logs/stdio'>{{failure.step_name}}</a>
          <div>{{failure.piece | falsy_to_empty}}</div>
        </td>
        <td>
          <a class='fail_link' href="{{ builder_url + '/builds/' + failure.failing_build }}">F</a>
          <template if='{{failure.passing_build}}'>
            <a class='pass_link' href="{{ builder_url + '/builds/' + failure.passing_build }}">P</a>
          </template>
        </td>
        <td>
          <nb-changelogs passing="{{failure.passing_revisions}}" failing="{{failure.failing_revisions}}"></nb-changelogs>
        </td>
        <td>{{ failure.last_result_time | since_string }}</td>
        <td>{{ failure.would_close_tree }}</td>
       </tr>
       </template>
    </template>
    </table>
  </template>
  <script>
    Polymer('nb-alert-list', {
      since_string: function(value) {
        // Buildbot talks to us in seconds, js expect milliseconds
        date = new Date(value * 1000.0);
        return humanized_time_span(date);
      },
      falsy_to_empty: function(value) {
        return value ? value : '';
      },
      master_name: function(value) {
        var url_parts = value.split('/');
        var long_name = url_parts[url_parts.length - 1];
        if (long_name.indexOf('chromium.') == 0) {
          return long_name.slice('chromium.'.length);
        }
        return long_name;
      }
    });
  </script>
</polymer-element>

<polymer-element name='nb-grouped-alert-list' attributes='groups' noscript>
<template>
  <table>
  <tr><th>reason</th><th>builders</th></tr>
  <template repeat="{{ group in groups }}">
    <tr>
      <td>
        {{ group.failures[0].step_name }}
        <template if='{{group.failures[0].piece}}'>
          {{ group.failures[0].piece }}
        </template>
      </td>
      <td>
        <template if="{{group.likely_revisions.length < 10}}">
          <template repeat="{{ revision in group.likely_revisions }}">
            {{ revision }}
          </template>
        </template>
      </td>
      <td>
        <template repeat="{{ failure in group.failures }}">
          {{ failure.builder_name }}
        </template>
      </td>
    </tr>
  </template>
  </table>
</template>
</polymer-element>

<polymer-element name="nb-ignores-list" attributes='ignores'>
<template>
    <h3>Ignore Rules</h3>
    <table>
    <tr><th>pattern</th><th>added</th></tr>
    <template repeat="{{ ignore in ignores }}">
    <tr>
    <td>{{ignore.pattern}}</td>
    <td>{{ignore.date | since_string}}</td>
    </tr>
    </template>
    </table>
</template>
<script>
Polymer('nb-ignores-list', {
  since_string: function(value) {
    // Buildbot talks to us in seconds, js expect milliseconds
    date = new Date(value * 1000.0);
    return humanized_time_span(date);
  },
});
</script>
</polymer-element>

<polymer-element name="nb-main" attributes='failures filteredFailures displayedFailures'>
<template>
<div>This is a debugging view for building a global-failures datastream (<a href='/data'>/data</a>) off of which we can build tools to automatically maintain Chromium bots.  <a href='https://github.com/eseidel/cycletimes/tree/master/nannybot'>Source<a></div>
<div>
Updated: {{ response.date | since_string }},
{{ displayedFailures.length }} failures ({{ failures.length - displayedFailures.length }} ignored)
</div>
<nb-alert-list failures='{{displayedFailures}}'></nb-alert-list>
<nb-grouped-alert-list groups='{{grouped_alerts}}'></nb-grouped-alert-list>
<nb-ignores-list ignores='{{response.ignores}}'></nb-ignores-list>
<core-ajax url="/data" id='loader' auto handleAs="json" response="{{ response }}"></core-ajax>
</template>
<script>
Polymer('nb-main', {
  ready: function() {
    console.log('read');
    window.setInterval(30 * 1000, function() {
      console.log('refreshing');
      this.$.loader.go();
    });
  },
  responseChanged: function(oldValue, newValue) {
    this.failures = newValue.content;
    this.filteredFailures = this.failures.filter(function(failure) { return !failure.ignored_by.length });
    // Could have a check-box to toggle these.
    this.displayedFailures = this.filteredFailures;
    this.grouped_alerts = newValue.reason_groups;
    this.grouped_alerts.sort(function(a, b) { return a.reason_key.localeCompare(b.reason_key); })
  },
  since_string: function(value) {
    // Buildbot talks to us in seconds, js expect milliseconds
    date = new Date(value * 1000.0);
    return humanized_time_span(date);
  },
});
</script>
</polymer-element>

<nb-main></nb-main>

<!-- <form action='/ignore' method='post'>
<core-field>
  <label>Pattern:</label><input name='pattern'>
</core-field>
<input type='submit'>
</form> -->
</body>
</html>
